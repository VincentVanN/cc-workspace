# Container Strategies — E2E Validator Reference

## Overlay strategy (preferred — repos have docker-compose)

When repos already have `docker-compose.yml`, generate an **overlay** file that:
- Creates a shared e2e network
- Overrides env vars for test isolation
- Adds health checks if missing
- Maps worktree paths as build contexts

### Template: docker-compose.e2e.yml (overlay)

```yaml
# E2E overlay — use with: docker compose -f ../repo/docker-compose.yml -f ./e2e/docker-compose.e2e.yml up
# Generated by e2e-validator agent

networks:
  e2e:
    driver: bridge

services:
  # Override each service to join the e2e network and use test env
  api:
    networks:
      - e2e
    environment:
      - APP_ENV=testing
      - DB_DATABASE=app_test
      - LOG_LEVEL=debug
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  frontend:
    networks:
      - e2e
    environment:
      - VITE_API_URL=http://api:8000
      - NODE_ENV=development
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000"]
      interval: 5s
      timeout: 3s
      retries: 10

  db:
    networks:
      - e2e
    environment:
      - POSTGRES_DB=app_test
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=test
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test"]
      interval: 3s
      timeout: 2s
      retries: 10
    tmpfs:
      - /var/lib/postgresql/data  # RAM disk for speed
```

### Worktree build context override

When testing session branches, override the build context to point to worktrees:

```yaml
services:
  api:
    build:
      context: /tmp/e2e-api
      dockerfile: Dockerfile
  frontend:
    build:
      context: /tmp/e2e-frontend
      dockerfile: Dockerfile
```

## Standalone strategy (repos have NO docker-compose)

Generate a complete `docker-compose.e2e.yml` from scratch.

### Per-stack templates

#### PHP/Laravel
```yaml
services:
  api:
    build:
      context: /tmp/e2e-api
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=testing
      - APP_KEY=${APP_KEY}
      - DB_CONNECTION=pgsql
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=app_test
      - DB_USERNAME=test
      - DB_PASSWORD=test
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 5s
      retries: 10
      start_period: 30s
    command: >
      sh -c "php artisan migrate --force && php artisan serve --host=0.0.0.0 --port=8000"
    networks:
      - e2e
```

#### Node.js (Express/Fastify)
```yaml
services:
  api:
    build:
      context: /tmp/e2e-api
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=test
      - DATABASE_URL=postgresql://test:test@db:5432/app_test
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/health"]
      interval: 5s
      retries: 10
    networks:
      - e2e
```

#### Vue/Quasar (frontend)
```yaml
services:
  frontend:
    build:
      context: /tmp/e2e-frontend
    ports:
      - "9000:9000"
    environment:
      - VITE_API_URL=http://localhost:8000
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000"]
      interval: 5s
      retries: 10
    command: npx quasar dev --port 9000 --hostname 0.0.0.0
    networks:
      - e2e
```

#### React/Next
```yaml
services:
  frontend:
    build:
      context: /tmp/e2e-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000"]
      interval: 5s
      retries: 10
    networks:
      - e2e
```

#### Python/FastAPI
```yaml
services:
  api:
    build:
      context: /tmp/e2e-api
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://test:test@db:5432/app_test
      - ENVIRONMENT=testing
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 5s
      retries: 10
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    networks:
      - e2e
```

#### Go
```yaml
services:
  api:
    build:
      context: /tmp/e2e-api
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgresql://test:test@db:5432/app_test
      - ENV=test
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 5s
      retries: 10
    networks:
      - e2e
```

### Database templates

#### PostgreSQL
```yaml
  db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=app_test
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=test
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test"]
      interval: 3s
      retries: 10
    tmpfs:
      - /var/lib/postgresql/data
    networks:
      - e2e
```

#### MySQL
```yaml
  db:
    image: mysql:8.0
    environment:
      - MYSQL_DATABASE=app_test
      - MYSQL_USER=test
      - MYSQL_PASSWORD=test
      - MYSQL_ROOT_PASSWORD=root
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 3s
      retries: 10
    tmpfs:
      - /var/lib/mysql
    networks:
      - e2e
```

#### Redis
```yaml
  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      retries: 5
    networks:
      - e2e
```

#### MongoDB
```yaml
  mongo:
    image: mongo:7
    environment:
      - MONGO_INITDB_DATABASE=app_test
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 3s
      retries: 10
    tmpfs:
      - /data/db
    networks:
      - e2e
```

## Startup sequence

Always start in dependency order:
1. Databases (db, redis, mongo) — wait for healthy
2. Backend services (api) — wait for healthy
3. Frontend services — wait for healthy
4. Run tests

## Teardown

```bash
docker compose -f ./e2e/docker-compose.e2e.yml down -v --remove-orphans
```

Always use `-v` to remove test volumes and `--remove-orphans` for cleanup.
